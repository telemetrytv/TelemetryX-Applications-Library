<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TelemetryX Applications Development Harness</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a1a;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 2rem;
      flex-shrink: 0;
      border-bottom: 1px solid #333;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
    }

    .logo svg {
      width: 24px;
      height: 24px;
      stroke: #667eea;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex: 1;
    }

    .app-selector {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .app-selector label {
      font-weight: 500;
      color: #ccc;
      font-size: 0.9rem;
    }

    .app-selector select {
      padding: 0.5rem 1rem;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2a2a2a;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      min-width: 220px;
      transition: all 0.3s;
    }

    .app-selector select:hover {
      border-color: #667eea;
      background: #333;
    }

    .app-selector select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: #2a2a2a;
      color: #ccc;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .btn-primary:hover {
      background: #5a67d8;
      border-color: #5a67d8;
    }

    .btn-secondary:hover {
      background: #333;
      border-color: #555;
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .status {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 16px;
      font-size: 0.8rem;
      color: #ccc;
    }

    .status-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }

    .status-indicator.error {
      background: #ef4444;
      animation: none;
    }

    .status-indicator.loading {
      background: #f59e0b;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .render-container {
      width: 75%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #222;
      position: relative;
    }

    .settings-container {
      width: 25%;
      background: #1a1a1a;
      border-left: 1px solid #333;
      display: flex;
      flex-direction: column;
    }

    .render-frame {
      /* Container that maintains 16:9 aspect ratio and scales to fit available space */
      width: 100%;
      max-width: calc(100vh * 16 / 9);
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      position: relative;
      margin: 20px;
    }

    .render-iframe {
      width: calc(100% - 16px);
      height: calc(100% - 16px);
      border: none;
      background: white;
      border-radius: 4px;
      position: absolute;
      top: 8px;
      left: 8px;
    }

    .settings-header {
      padding: 1rem;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .settings-iframe {
      flex: 1;
      border: none;
      background: white;
    }

    .loading-overlay {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
      z-index: 10;
      border-radius: 4px;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.75rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #fff;
      padding: 1.5rem;
      border-radius: 6px;
      text-align: center;
      margin: 1rem;
    }

    .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      color: #666;
      text-align: center;
    }

    .placeholder svg {
      stroke: #444;
    }

  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2" />
        <line x1="8" y1="21" x2="16" y2="21" />
        <line x1="12" y1="17" x2="12" y2="21" />
      </svg>
      TelemetryX Dev Harness
    </div>
    
    <div class="controls">
      <div class="app-selector">
        <label for="app-select">Application:</label>
        <select id="app-select">
          <option value="">Select an application...</option>
        </select>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" id="reload-btn" disabled>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6M1 20v-6h6" />
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
          </svg>
          Reload
        </button>
        <button class="btn btn-secondary" id="build-btn" disabled>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="12" y1="18" x2="12" y2="12" />
            <line x1="9" y1="15" x2="15" y2="15" />
          </svg>
          Build
        </button>
      </div>
      
      <div class="status">
        <div class="status-indicator" id="status-indicator"></div>
        <span id="status-text">Ready</span>
      </div>
    </div>
  </div>
  
  <div class="main-container">
    <!-- Render Application (3/4 width, 1080p aspect ratio) -->
    <div class="render-container">
      <div class="render-frame" id="render-frame">
        <iframe 
          id="render-iframe" 
          class="render-iframe"
          sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
          style="display: none;"
        ></iframe>
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
          <div class="loading-spinner"></div>
          Loading application...
        </div>
        <div class="error-message" id="error-message" style="display: none;">
          <h3>Application Error</h3>
          <p id="error-text"></p>
        </div>
        <div class="placeholder" id="placeholder">
          <div style="text-align: center;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <rect x="2" y="3" width="20" height="14" rx="2" />
              <line x1="8" y1="21" x2="16" y2="21" />
              <line x1="12" y1="17" x2="12" y2="21" />
            </svg>
            <p style="margin-top: 1rem;">Select an application to preview</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Panel (1/4 width, full height) -->
    <div class="settings-container">
      <div class="settings-header">
        Application Settings
      </div>
      <iframe 
        id="settings-iframe" 
        class="settings-iframe"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
        style="display: none;"
      ></iframe>
      <div class="placeholder" id="settings-placeholder" style="flex: 1;">
        <div style="text-align: center;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <circle cx="12" cy="12" r="3" />
            <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
          </svg>
          <p style="margin-top: 0.75rem; font-size: 0.9rem;">Settings will appear here</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Include TelemetryX Bridge Stub -->
  <script type="module">
    import TelemetryXBridgeStub from './bridge-stub.js';
    
    // Initialize the bridge stub globally
    window.bridgeStub = new TelemetryXBridgeStub();
    console.log('🚀 TelemetryX Bridge Stub initialized');
    
    // Make it available for debugging
    window.TelemetryXBridgeStub = TelemetryXBridgeStub;
  </script>

  <script>
    const appSelect = document.getElementById('app-select');
    const reloadBtn = document.getElementById('reload-btn');
    const buildBtn = document.getElementById('build-btn');
    const renderIframe = document.getElementById('render-iframe');
    const settingsIframe = document.getElementById('settings-iframe');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const placeholder = document.getElementById('placeholder');
    const settingsPlaceholder = document.getElementById('settings-placeholder');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    
    let currentApp = null;
    let applications = [];

    // No manual scaling needed - CSS handles responsive sizing with aspect-ratio

    // WebSocket for hot reload
    const ws = new WebSocket('ws://localhost:3001');
    
    ws.onopen = () => {
      console.log('Connected to development server');
      updateStatus('Connected', 'success');
    };
    
    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      if (message.type === 'reload' && currentApp) {
        console.log('Reloading due to file change:', message.path);
        reloadApp();
      }
    };
    
    ws.onerror = () => {
      updateStatus('Connection error', 'error');
    };
    
    ws.onclose = () => {
      updateStatus('Disconnected', 'error');
    };

    // Fetch available applications
    async function fetchApplications() {
      try {
        const response = await fetch('/api/applications');
        applications = await response.json();
        
        // Clear and populate select
        appSelect.innerHTML = '<option value="">Select an application...</option>';
        
        applications.forEach(app => {
          const option = document.createElement('option');
          option.value = app.id;
          option.textContent = `${app.name} ${app.version}`;
          if (!app.hasDistFolder) {
            option.textContent += ' (needs build)';
            option.style.color = '#666';
          }
          appSelect.appendChild(option);
        });
        
        // Auto-load the first application if available
        if (applications.length > 0) {
          const firstApp = applications.find(app => app.hasDistFolder) || applications[0];
          if (firstApp) {
            appSelect.value = firstApp.id;
            loadApp();
          }
        }
        
        // Applications loaded successfully
        
        updateStatus('Ready', 'success');
      } catch (error) {
        console.error('Error fetching applications:', error);
        updateStatus('Error loading apps', 'error');
      }
    }

    // Load application
    function loadApp() {
      const selectedId = appSelect.value;
      const app = applications.find(a => a.id === selectedId);
      
      if (!app) return;
      
      if (!app.hasDistFolder) {
        if (confirm(`Application "${app.name}" needs to be built first. Build now?`)) {
          buildApp(app);
        }
        return;
      }
      
      currentApp = app;
      placeholder.style.display = 'none';
      settingsPlaceholder.style.display = 'none';
      errorMessage.style.display = 'none';
      loadingOverlay.style.display = 'flex';
      
      let renderLoaded = false;
      let settingsLoaded = false;
      
      function checkBothLoaded() {
        if (renderLoaded && settingsLoaded) {
          loadingOverlay.style.display = 'none';
          reloadBtn.disabled = false;
          updateStatus(`Loaded: ${app.name}`, 'success');
          
          // Application loaded successfully
        }
      }
      
      // Load the render iframe
      renderIframe.src = `/apps/${app.id}/index.html`;
      renderIframe.style.display = 'block';
      
      renderIframe.onload = () => {
        renderLoaded = true;
        checkBothLoaded();
        
        // Bridge stub automatically handles communication with all iframes
        console.log('🔗 Bridge stub ready for render iframe communication');
      };
      
      renderIframe.onerror = () => {
        loadingOverlay.style.display = 'none';
        showError(`Failed to load render view: ${app.name}`);
      };
      
      // Load the settings iframe
      settingsIframe.src = `/apps/${app.id}/settings.html`;
      settingsIframe.style.display = 'block';
      
      settingsIframe.onload = () => {
        settingsLoaded = true;
        checkBothLoaded();
        console.log('📝 Settings iframe loaded');
      };
      
      settingsIframe.onerror = () => {
        console.warn(`Settings not available for ${app.name}`);
        settingsLoaded = true; // Don't block loading if settings fail
        checkBothLoaded();
      };
    }

    // Reload current application
    function reloadApp() {
      if (!currentApp) return;
      
      loadingOverlay.style.display = 'flex';
      renderIframe.src = '';
      settingsIframe.src = '';
      
      setTimeout(() => {
        loadApp();
      }, 100);
    }

    // Build application
    async function buildApp(app) {
      try {
        updateStatus(`Building ${app.name}...`, 'loading');
        buildBtn.disabled = true;
        
        const response = await fetch(`/api/build/${app.id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          updateStatus(`Built ${app.name}`, 'success');
          await fetchApplications(); // Refresh the list
          appSelect.value = app.id; // Reselect the app
          loadApp(); // Auto-load after successful build
        } else {
          const error = await response.json();
          showError(`Build failed: ${error.error}`);
        }
      } catch (error) {
        showError(`Build error: ${error.message}`);
      } finally {
        buildBtn.disabled = false;
      }
    }

    // Show error message
    function showError(message) {
      errorText.textContent = message;
      errorMessage.style.display = 'block';
      renderIframe.style.display = 'none';
      settingsIframe.style.display = 'none';
      loadingOverlay.style.display = 'none';
      updateStatus('Error', 'error');
    }

    // Update status
    function updateStatus(text, type) {
      statusText.textContent = text;
      statusIndicator.className = 'status-indicator';
      
      if (type === 'error') {
        statusIndicator.classList.add('error');
      } else if (type === 'loading') {
        statusIndicator.classList.add('loading');
      }
    }

    // Event listeners
    appSelect.addEventListener('change', () => {
      const selectedId = appSelect.value;
      const app = applications.find(a => a.id === selectedId);
      
      if (app) {
        buildBtn.disabled = !app.hasDistFolder;
        loadApp(); // Auto-load when selection changes
      } else {
        buildBtn.disabled = true;
        // Show placeholders when no app selected
        placeholder.style.display = 'flex';
        settingsPlaceholder.style.display = 'flex';
        renderIframe.style.display = 'none';
        settingsIframe.style.display = 'none';
        currentApp = null;
      }
    });

    reloadBtn.addEventListener('click', reloadApp);
    buildBtn.addEventListener('click', () => {
      const selectedId = appSelect.value;
      const app = applications.find(a => a.id === selectedId);
      if (app) buildApp(app);
    });

    // Initialize
    fetchApplications();
  </script>
</body>
</html>